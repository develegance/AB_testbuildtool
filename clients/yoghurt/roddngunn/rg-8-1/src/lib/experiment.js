const multiBuy = [
  {
    name: 'The Gunn Polo',
    longName: 'The Gunn Polo',
    message: '$49* WHEN YOU BUY 2 OR MORE',
    pdp: 'https://www.roddandgunn.com/us/clothing/polos/the-gunn-polo/003396-60.html',
    items: [
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw00518995/images/003396/KP0005_ADRIATIC_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        pid: '003396',
        vgid: '003396-77',
        color: 'ADRIATIC'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw123d89ea/images/003396/KP0005_DUSTYROSE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        pid: '003396',
        vgid: '003396-58',
        color: 'dustyrose'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwdc54b953/images/003396/KP0005_DUSK_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '003396-43',
        color: 'DUSK'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw3e1b62ed/images/003396/KP0005_JADE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '003396-76',
        color: 'JADE'
      }
    ]
  },
  {
    name: 'The Gunn T-Shirt',
    longName: 'The Gunn T-Shirt',
    message: '$35* WHEN YOU BUY 2 OR MORE',
    pdp: 'https://www.roddandgunn.com/us/clothing/t-shirts/the-gunn-t-shirt-/004120.html',
    pid: '004120',
    items: [
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw3d49abc7/images/004120/PP0321_LIQUORICE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004120-27',
        color: 'LIQUORICE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw649613c0/images/004120/PP0321_PEBBLE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004120-07',
        color: 'PEBBLE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw90b8c2ae/images/004120/PP0321_GRANITE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004120-28',
        color: 'GRANITE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dweafbaf40/images/004120/PP0321_HEATHER-BLUE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004120-30',
        color: 'HEATHER BLUE'
      }
    ]
  },
  {
    name: 'Gunn Oxford Sports Fit Shirt',
    longName: 'Gunn Oxford Sports Fit Shirt',
    message: '$99.50* WHEN YOU BUY 2 OR MORE',
    pdp: 'https://www.roddandgunn.com/us/clothing/shirts/gunn-oxford-sports-fit-shirt/006582.html',
    pid: '006582',
    items: [
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw517b7fd2/images/006582/LP5261_SKY_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '006582-02',
        color: 'SKY'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwe0c6d18e/images/006582/LP5261_SNOW_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '006582-01',
        color: 'SNOW'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw0839a33b/images/006582/LP5261_TARMAC_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '006582-04',
        color: 'TARMAC'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw255ac6d4/images/006582/LP5261_MERLOT_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '006582-05',
        color: 'MERLOT'
      }
    ]
  },
  {
    name: 'The Peaks Custom Short',
    longName: 'The Peaks Custom Short',
    message: '$75* WHEN YOU BUY 2 OR MORE',
    pdp: 'https://www.roddandgunn.com/us/clothing/shorts/the-peaks-custom-short/005690.html',
    pid: '005690',
    items: [
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwa990017b/images/005690/UP0641_MIDNIGHT_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '005690-26',
        color: 'MIDNIGHT'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw9dbfbd60/images/005690/UP0641_SAND_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '005690-11',
        color: 'SAND'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw5f31a5d5/images/005690/UP0641_MARINE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '005690-01',
        color: 'MARINE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw55d8ac99/images/005690/UP0641_CORAL_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '005690-16',
        color: 'CORAL'
      }
    ]
  },
  {
    name: 'Gunn Crew Neck Sweat',
    longName: 'Gunn Crew Neck Sweatshirt',
    message: '$79.50* WHEN YOU BUY 2 OR MORE',
    pdp: 'https://www.roddandgunn.com/us/clothing/sweatshirts/gunn-crew-neck-sweatshirt/007063.html',
    pid: '007063',
    items: [
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwd5c85dc6/images/007063/SP0390_ECLIPSE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '007063-01',
        color: 'ECLIPSE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwa4ee0319/images/007063/SP0390_FOG_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '007063-05',
        color: 'FOG'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwd840cf06/images/007063/SP0390_INK_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '007063-06',
        color: 'INK'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw3021956d/images/007063/SP0390_PORT_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '007063-04',
        color: 'PORT'
      }
    ]
  },
  {
    name: 'Ls Gunn Polo',
    longName: 'Long Sleeve Gunn Polo',
    message: '$59.50* WHEN YOU BUY 2 OR MORE',
    pdp: 'https://www.roddandgunn.com/us/clothing/sweatshirts/gunn-crew-neck-sweatshirt/007063.html',
    pid: '004539',
    items: [
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw57307388/images/004539/KP0008_REGATTA_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004539-21',
        color: 'REGATTA'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw4c396c07/images/004539/KP0008_STONE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004539-10',
        color: 'STONE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw368061b8/images/004539/KP0008_ICE_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004539-39',
        color: 'ICE'
      },
      {
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwbd34b4ec/images/004539/KP0008_DEEP-OCEAN_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        vgid: '004539-14',
        color: 'DEEP OCEAN'
      }
    ]
  }
];

console.log('test bucketed');
const ID = 'rg-8-1';

let computedInnerWidth = window.innerWidth;
const isIncludesFromProdList = () => {
  const cartProduct = document
    .querySelector(
      '#cart-table > tbody > tr:nth-child(1) > td.item-details > div.product-list-item > div.item-name-container > div > a'
    )
    .innerText.toLowerCase();

  const res = multiBuy.find((d) => {
    return cartProduct.includes(d.name.toLowerCase());
  });
  if (res?.items) {
    const res2 = res?.items?.filter((item) => !cartProduct.includes(item.color.toLowerCase()));
    res.items = res2?.length > 3 ? res2.slice(0, 3) : res2;
    return res;
  }
    return [];
};

const addToCart = (pid, size, prodName) => {
  const fd = new FormData();
  fd.append('Quantity', '1');
  fd.append('cartAction', 'add');
  fd.append('pid', `${pid}-${size}`);
  fd.append('preferredStoreId', '');

  $.ajax({
    url: 'https://www.roddandgunn.com/on/demandware.store/Sites-rodd-us-Site/en_US/Cart-AddProduct?format=ajax',
    data: fd,
    processData: false,
    contentType: false,
    type: 'POST',
    success(data) {
      window.location.reload();
    }
  });
};

const getTranslateX = () => {
  const style = window.getComputedStyle(
    document.querySelector(
      '#cart-items-form > fieldset > div > div.rg-8-1-similar-container > .prod-wrapper'
    )
  );
  const matrix = new WebKitCSSMatrix(style.transform);
  return matrix.m41;
};

const setSminiliarProducts = (similiarComponents, prodLists) => {
  if (!document.querySelector('.add-another-to-save')) {
    if (prodLists?.items) {
      document
      .querySelector('.cart-footer')
      .insertAdjacentHTML('beforebegin', '<p class="add-another-to-save">add another to save</p>');
    }
  }
  if (prodLists?.items) {
    document.querySelector('.cart-coupon-code').classList.add('rg-8-1-cart-coupon-code');
    if (computedInnerWidth > 767) {
      document
        .querySelector('.rg-8-1-similar-container.sm-screen-bp')
        ?.classList.add('rg-8-1-none');
      document
        .querySelector('.rg-8-1-similar-container.lg-screen-bp')
        ?.classList.remove('rg-8-1-none');

      //console.log('> 767');
      if (!document.querySelector('.rg-8-1-similar-container.lg-screen-bp')) {
        document
          .querySelector('.cart-coupon-code')
          .insertAdjacentHTML(
            'beforebegin',
            `<div class="${ID}-similar-container lg-screen-bp"><button type="button" id="prevSlideButton" class="prev-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button><div class="prod-wrapper">${similiarComponents.join(
              '\n'
            )}</div><button type="button" id="nextSlideButton" class="next-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button> <div class="product-indecator"><span></span><span></span><span></span></div></div>`
          );
      }
    } else if (computedInnerWidth <= 767) {
      document
        .querySelector('.rg-8-1-similar-container.lg-screen-bp')
        ?.classList.add('rg-8-1-none');
      document
        .querySelector('.rg-8-1-similar-container.sm-screen-bp')
        ?.classList.remove('rg-8-1-none');

      //console.log('<= 767');
      if (!document.querySelector('.rg-8-1-similar-container.sm-screen-bp')) {
        document
          .querySelector('#update-cart')
          .insertAdjacentHTML(
            'beforebegin',
            `<div class="${ID}-similar-container sm-screen-bp"><button type="button" id="prevSlideButton" class="prev-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button><div class="prod-wrapper">${similiarComponents.join(
              '\n'
            )}</div><button type="button" id="nextSlideButton" class="next-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button> <div class="product-indecator"><span></span><span></span><span></span></div></div>`
          );
      }
    }
    Array.from(document.querySelectorAll('.similar-product')).forEach((item, index) => {
      item.querySelector(`#${ID}-quick-cart`).addEventListener('click', async () => {
        //console.log(isIncludesFromProdList().items[index]);
        Array.from(document.querySelectorAll('.similar-product')).forEach((it) => {
          it.querySelector(`#${ID}-quick-size`).classList.add(`${ID}-none`);
          it.querySelector(`#${ID}-quick-cart`).classList.remove(`${ID}-none`);
        });
        try {
          const response = await fetch(
            `https://www.roddandgunn.com/us/Product-Variation?pid=${prodLists.items[index].vgid}&dwvar_${prodLists.items[index].vgid}_color=${prodLists.items[index].color}&source=tile&attribute=color`
          );
          const data = await response.text();
          if (data) {
            //eslint-disable-next-line no-param-reassign
            item.querySelector(`#${ID}-quick-size .parsed-size-list`).innerHTML = data;
            item.querySelector(`#${ID}-quick-size`).classList.remove(`${ID}-none`);
            item.querySelector(`#${ID}-quick-cart`).classList.add(`${ID}-none`);
            Array.from(item.querySelectorAll('.selectable a')).forEach((li) => {
              //eslint-disable-next-line no-param-reassign, no-script-url
              li.href = 'javascript:void(0)';
              li.addEventListener('click', () => {
                addToCart(prodLists.items[index].vgid, li.innerText, prodLists.name);
              });
            });
          }
          item.querySelector(`#${ID}-close`).addEventListener('click', () => {
            item.querySelector(`#${ID}-quick-size`).classList.add(`${ID}-none`);
            item.querySelector(`#${ID}-quick-cart`).classList.remove(`${ID}-none`);
          });
        } catch (error) {
          console.log(error);
        }
      });
    });

    let inActionBar = false;

    const indecatores = Array.from(
      document.querySelectorAll(
        '#cart-items-form .rg-8-1-similar-container .product-indecator span'
      )
    );
    let indecatorIndex = 1;
    indecatores[indecatorIndex].classList.add('bg-red-danger');
    document.getElementById('prevSlideButton').addEventListener('click', () => {
      if (getTranslateX() < 81 && !inActionBar) {
        inActionBar = true;
        setTimeout(() => {
        inActionBar = false;
        console.log('setTimeout inActionBar', inActionBar);
        }, 500);
        const te = getTranslateX() + 206;
        //console.log(te);
        document
          .querySelector(
            '#cart-items-form > fieldset > div > div.rg-8-1-similar-container > .prod-wrapper'
          )
          .style.setProperty('--tranX', `${te}px`);
        indecatores[indecatorIndex - 1];
        indecatorIndex -= 1;
        indecatores.forEach((indecator, index) => {
          if (index === indecatorIndex) {
            indecator.classList.add('bg-red-danger');
          } else {
            indecator.classList.remove('bg-red-danger');
          }
        });
        if (indecatorIndex === 0) {
          document.getElementById('prevSlideButton').style.opacity = 0;
        } else {
          document.getElementById('prevSlideButton').style.opacity = 1;
          document.getElementById('nextSlideButton').style.opacity = 1;
        }
      }
    });
    document.getElementById('nextSlideButton').addEventListener('click', () => {
      if (getTranslateX() > -200 && !inActionBar) {
        inActionBar = true;
        setTimeout(() => {
        inActionBar = false;
        console.log('setTimeout inActionBar', inActionBar);
        }, 500);
        const te = getTranslateX() - 206;
        document
          .querySelector(
            '#cart-items-form > fieldset > div > div.rg-8-1-similar-container > .prod-wrapper'
          )
          .style.setProperty('--tranX', `${te}px`);
        indecatores[indecatorIndex + 1];
        indecatorIndex += 1;
        indecatores.forEach((indecator, index) => {
          if (index === indecatorIndex) {
            indecator.classList.add('bg-red-danger');
          } else {
            indecator.classList.remove('bg-red-danger');
          }
        });
      }

      if (indecatorIndex === 2) {
        document.getElementById('nextSlideButton').style.opacity = 0;
      } else {
        document.getElementById('nextSlideButton').style.opacity = 1;
        document.getElementById('prevSlideButton').style.opacity = 1;
      }

      //console.log(getTranslateX());
    });
  } else {
    //document
    //.querySelector('.cart-coupon-code').classList.add('product-smiliar');
    //console.log('not setSminiliarProducts');
    //document.querySelector('.add-another-to-save').classList.add('rg-8-1-none');
  }
};

var waitForEl = function (selector, callback) {
  let count = 0;
  if (document.querySelector(selector) != null) {
    callback();
  } else if (count < 100) {
    setTimeout(() => {
      waitForEl(selector, callback, ++count);
    }, 100);
  }
};

const WidthChange = () => {
  computedInnerWidth = window.innerWidth;
  const prodLists = isIncludesFromProdList();
  const similiarComponents = prodLists?.items?.map((item) => {
    return `<div class="similar-product">
                <img src="${item.image}" alt="${item.name}">
                <p class="product-name">${prodLists.longName}</p>
                <button type="button" id="${ID}-quick-cart" class="similar-product--cart">+ ADD TO CART</button>
                <div class="similar-product--size ${ID}-none" id="${ID}-quick-size">
                  <button id="${ID}-close" type="button" class="close-size">x</button>
                  <div class="parsed-size-list"></div>
                </div>
              </div>`;
  });
  waitForEl('.cart-footer', () => {
    setSminiliarProducts(similiarComponents, prodLists);
  });
};

waitForEl(
  '#cart-table > tbody > tr:nth-child(1) > td.item-details > div.product-list-item > div.item-name-container > div > a',
  () => {
    document.querySelector('body').classList.add(`${ID}`);

    const mq = window.matchMedia('(min-width: 767px)');
    mq.addListener(WidthChange);
    try {
      const fetchDiscount = async (url) => {
        const response = await fetch(url);
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        //console.log(doc);
        const discount = doc.querySelector('#product-content > div.promotion .callout-message span') ? doc.querySelector('#product-content > div.promotion .callout-message span').innerText.trim() : null;
        //console.log(discount);
        return discount;
      };

      let cartcount;
      waitForEl('.header-action span.quantity', () => {
        cartcount = parseInt(document.querySelector('.header-action span.quantity').innerText);

        checkforCartItems();
      });

      function checkforCartItems() {
        let total = 0;

        const inputList = document.querySelectorAll('.item-quantity input');

        for (let i = 0; i < inputList.length; i++) {
            total += parseInt(inputList[i].value);
        }

        if (total == cartcount) {
          addDiscount();
        } else {
          setTimeout(() => {
            checkforCartItems();
          }, 200);
        }
      }

      function addDiscount() {
        const cartProd = Array.from(document.querySelectorAll('#cart-table > tbody > tr > td.item-details > div.product-list-item > div.item-name-container > div.name > a'));

                const getProductUrl = () => {
                  return cartProd.map((item) => item.href);
                };

                console.log(cartProd);
                console.log(getProductUrl());

                getProductUrl().forEach(async (url, index) => {
                const discountBanner = await fetchDiscount(url);
                  console.log(url);

                  if (discountBanner) {
                    const productDiv = document.querySelector(`#cart-table > tbody > tr:nth-child(${index + 1}) > td.item-details > div.product-list-item > div.item-name-container`);
                    productDiv.insertAdjacentHTML('beforeend', `<div class="discount-banner"><a href="${url}">${discountBanner}</a></div>`);
                  }
                });
      }
    } catch (error) {
      console.error(error);
    }
    WidthChange();
  }
);

export default () => {
  //setup(); //use if needed

  console.log(ID);
};

const completeLook = [
  {
    name: 'Ellerslie Sports Fit Shirt',
    items: [
      {
        name: 'Gunn 7" Resort Short',
        vgid: '007309-03',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw4bc7ffca/images/007309/UP0741_VERDANT_FT_LGE.jpg?sw=166&sh=205&sm=fit'

        //color: 'ADRIATIC'
      },
      {
        name: 'Endeavour Spirit Sneaker',
        vgid: '007718-03',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwd2689f38/images/007718/ZX0494_NIMBUS-CLOUD_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'Thomsons Crossing T-Shirt',
        vgid: '007352-01',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwbebe4143/images/007352/PP0406_PETROL_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      }
    ]
  },
  {
    name: 'Murchison Coat',
    items: [
      {
        name: 'Gunn Straight Fit Jean',
        vgid: '007297-10',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwf7cfb2d0/images/007297/VJ0424_BLUESTONE_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'The Gunn Polo',
        vgid: '003396-61',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw2d2a1fb3/images/003396/KP0005_FLAME_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'Dargaville Chelsea Boot',
        vgid: '007750-01',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwa47c6d8e/images/007750/ZX0506_ONYX_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      }
    ]
  },
  {
    name: 'Frankleigh Pass T-Shirt',
    items: [
      {
        name: 'The Gunn 9" Short',
        vgid: '003059-04',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw89f7518b/images/003059/UP0514_SAND_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'Sussex Street Sneaker',
        vgid: '007754-01',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw4f9413f2/images/007754/ZX0496_NERO_FT_LGE.jpg?sw=166&sh=205&sm=fit',
        color: 'NERO'
      },
      {
        name: 'The Cascades Sports Fit Jacket',
        vgid: '007345-04',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwd1b27d37/images/007345/BP1322_SAND_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      }
    ]
  },
  {
    name: 'Seaford Sports Fit Shirt',
    items: [
      {
        name: 'Thomas Road Chino Pant',
        vgid: '006171-16',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw6be0bfda/images/006171/VP0558_PEBBLE_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'The Gunn T-Shirt',
        vgid: '004120-07',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw649613c0/images/004120/PP0321_PEBBLE_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'Endeavour Sail Sneaker',
        vgid: '007633-04',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw6925fca2/images/007633/ZX0493_DARK-TAUPE_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      }
    ]
  },
  {
    name: 'The Jack Jacket',
    items: [
      {
        name: 'Motion 2 Straight Jean',
        vgid: '006370-03',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw0c22f38f/images/006370/VJ0368_PEBBLE_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'Dunedin Military Boot',
        vgid: '007733-01',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dwcdaba607/images/007733/ZX0508_ONYX-WASH_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      },
      {
        name: 'Gunn Crew Neck Sweatshirt',
        vgid: '007063-04',
        image:
          'https://www.roddandgunn.com/dw/image/v2/BBRS_PRD/on/demandware.static/-/Sites-roddandgunn-master-catalog/default/dw3021956d/images/007063/SP0390_PORT_FT_LGE.jpg?sw=166&sh=205&sm=fit'
        //color: 'ADRIATIC'
      }
    ]
  }
];

console.log('test bucketed');
const ID = 'rg-8-2';
let computedInnerWidth = window.innerWidth;
const isIncludesFromProdList = () => {
  const cartProduct = document.querySelector(
    '#cart-table > tbody > tr:nth-child(1) > td.item-details > div.product-list-item > div.item-name-container > div > a'
  ).innerText;
  return completeLook.find((d) => {
    return cartProduct.includes(d.name);
  });
};

const addToCart = (pid, size, prodName) => {
  const fd = new FormData();
  fd.append('Quantity', '1');
  fd.append('cartAction', 'add');
  fd.append('pid', `${pid}-${size}`);
  fd.append('preferredStoreId', '');

  $.ajax({
    url: 'https://www.roddandgunn.com/on/demandware.store/Sites-rodd-us-Site/en_US/Cart-AddProduct?format=ajax',
    data: fd,
    processData: false,
    contentType: false,
    type: 'POST',
    success(data) {
      window.location.reload();
    }
  });
};
const getTranslateX = () => {
  const style = window.getComputedStyle(
    document.querySelector(
      '#cart-items-form > fieldset > div > div.rg-8-2-similar-container > .prod-wrapper'
    )
  );
  const matrix = new WebKitCSSMatrix(style.transform);
  return matrix.m41;
};

const setSminiliarProducts = (similiarComponents, prodLists) => {
  if (!document.querySelector('.add-another-to-save')) {
      if (prodLists?.items) {
        document
        .querySelector('.cart-footer')
        .insertAdjacentHTML('beforebegin', '<p class="add-another-to-save">Complete the look</p>');
      }
  }
  if (prodLists?.items) {
    document.querySelector('.cart-coupon-code').classList.add('rg-8-2-cart-coupon-code');
    if (computedInnerWidth > 767) {
      document
        .querySelector('.rg-8-2-similar-container.sm-screen-bp')
        ?.classList.add('rg-8-2-none');
      document
        .querySelector('.rg-8-2-similar-container.lg-screen-bp')
        ?.classList.remove('rg-8-2-none');

      //console.log('> 767');
      if (!document.querySelector('.rg-8-2-similar-container.lg-screen-bp')) {
        document
          .querySelector('.cart-coupon-code')
          .insertAdjacentHTML(
            'beforebegin',
            `<div class="${ID}-similar-container lg-screen-bp"><button type="button" id="prevSlideButton" class="prev-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button><div class="prod-wrapper">${similiarComponents.join(
              '\n'
            )}</div><button type="button" id="nextSlideButton" class="next-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button> <div class="product-indecator"><span></span><span></span><span></span></div></div>`
          );
      }
    } else if (computedInnerWidth <= 767) {
      document
        .querySelector('.rg-8-2-similar-container.lg-screen-bp')
        ?.classList.add('rg-8-2-none');
      document
        .querySelector('.rg-8-2-similar-container.sm-screen-bp')
        ?.classList.remove('rg-8-2-none');

      //console.log('<= 767');
      if (!document.querySelector('.rg-8-2-similar-container.sm-screen-bp')) {
        document
          .querySelector('#update-cart')
          .insertAdjacentHTML(
            'beforebegin',
            `<div class="${ID}-similar-container sm-screen-bp"><button type="button" id="prevSlideButton" class="prev-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button><div class="prod-wrapper">${similiarComponents.join(
              '\n'
            )}</div><button type="button" id="nextSlideButton" class="next-button-slider"><img src="https://sandbox.echologyx.com/wp-content/uploads/2022/07/icons8-arrow-24.png"/></button> <div class="product-indecator"><span></span><span></span><span></span></div></div>`
          );
      }
    }
    Array.from(document.querySelectorAll('.similar-product')).forEach((item, index) => {
      item.querySelector(`#${ID}-quick-cart`).addEventListener('click', async () => {
        //console.log(isIncludesFromProdList().items[index]);
        Array.from(document.querySelectorAll('.similar-product')).forEach((it) => {
          it.querySelector(`#${ID}-quick-size`).classList.add(`${ID}-none`);
          it.querySelector(`#${ID}-quick-cart`).classList.remove(`${ID}-none`);
        });
        try {
          const response = await fetch(
            `https://www.roddandgunn.com/us/Product-Variation?pid=${prodLists.items[index].vgid}&dwvar_${prodLists.items[index].vgid}_color=${prodLists.items[index].color}&source=tile&attribute=color`
          );
          const data = await response.text();
          if (data) {
            //eslint-disable-next-line no-param-reassign
            item.querySelector(`#${ID}-quick-size .parsed-size-list`).innerHTML = data;
            item.querySelector(`#${ID}-quick-size`).classList.remove(`${ID}-none`);
            item.querySelector(`#${ID}-quick-cart`).classList.add(`${ID}-none`);
            Array.from(item.querySelectorAll('.selectable a')).forEach((li) => {
              //eslint-disable-next-line no-param-reassign, no-script-url
              li.href = 'javascript:void(0)';
              li.addEventListener('click', () => {
                addToCart(prodLists.items[index].vgid, li.innerText, prodLists.name);
              });
            });
          }
          item.querySelector(`#${ID}-close`).addEventListener('click', () => {
            item.querySelector(`#${ID}-quick-size`).classList.add(`${ID}-none`);
            item.querySelector(`#${ID}-quick-cart`).classList.remove(`${ID}-none`);
          });
        } catch (error) {
          console.log(error);
        }
      });
    });

    let inActionBar = false;

    const indecatores = Array.from(
      document.querySelectorAll(
        '#cart-items-form .rg-8-2-similar-container .product-indecator span'
      )
    );
    let indecatorIndex = 1;
    indecatores[indecatorIndex].classList.add('bg-red-danger');
    document.getElementById('prevSlideButton').addEventListener('click', () => {
      if (getTranslateX() < 81 && !inActionBar) {
        inActionBar = true;
        setTimeout(() => {
        inActionBar = false;
        console.log('setTimeout inActionBar', inActionBar);
        }, 500);
        const te = getTranslateX() + 206;
        //console.log(te);
        document
          .querySelector(
            '#cart-items-form > fieldset > div > div.rg-8-2-similar-container > .prod-wrapper'
          )
          .style.setProperty('--tranX', `${te}px`);
        indecatores[indecatorIndex - 1];
        indecatorIndex -= 1;
        indecatores.forEach((indecator, index) => {
          if (index === indecatorIndex) {
            indecator.classList.add('bg-red-danger');
          } else {
            indecator.classList.remove('bg-red-danger');
          }
        });
        if (indecatorIndex === 0) {
          document.getElementById('prevSlideButton').style.opacity = 0;
        } else {
          document.getElementById('prevSlideButton').style.opacity = 1;
          document.getElementById('nextSlideButton').style.opacity = 1;
        }
      }
    });
    document.getElementById('nextSlideButton').addEventListener('click', () => {
      if (getTranslateX() > -200 && !inActionBar) {
        inActionBar = true;
        setTimeout(() => {
        inActionBar = false;
        console.log('setTimeout inActionBar', inActionBar);
        }, 500);
        const te = getTranslateX() - 206;
        document
          .querySelector(
            '#cart-items-form > fieldset > div > div.rg-8-2-similar-container > .prod-wrapper'
          )
          .style.setProperty('--tranX', `${te}px`);
        indecatores[indecatorIndex + 1];
        indecatorIndex += 1;
        indecatores.forEach((indecator, index) => {
          if (index === indecatorIndex) {
            indecator.classList.add('bg-red-danger');
          } else {
            indecator.classList.remove('bg-red-danger');
          }
        });
        if (indecatorIndex === 2) {
          document.getElementById('nextSlideButton').style.opacity = 0;
        } else {
          document.getElementById('nextSlideButton').style.opacity = 1;
          document.getElementById('prevSlideButton').style.opacity = 1;
        }
      }

      //console.log(getTranslateX());
    });
  } else {
    console.log('not setSminiliarProducts');
  }
};

const WidthChange = () => {
  computedInnerWidth = window.innerWidth;
  const prodLists = isIncludesFromProdList();

  const similiarComponents = prodLists?.items?.map((item) => {
    return `<div class="similar-product">
                <img src="${item.image}" alt="${item.name}">
                <div class="product-name"><p>${item.name}</p></div>
                <button type="button" id="${ID}-quick-cart" class="similar-product--cart">+ ADD TO CART</button>
                <div class="similar-product--size ${ID}-none" id="${ID}-quick-size">
                  <button id="${ID}-close" type="button" class="close-size">x</button>
                  <div class="parsed-size-list"></div>
                </div>
              </div>`;
  });
  waitForEl('.cart-footer', () => {
    setSminiliarProducts(similiarComponents, prodLists);
  });
};

var waitForEl = function (selector, callback) {
  let count = 0;
  if (document.querySelector(selector) != null) {
    callback();
  } else if (count < 100) {
    setTimeout(() => {
      waitForEl(selector, callback, ++count);
    }, 100);
  }
};

waitForEl(
  '#cart-table > tbody > tr:nth-child(1) > td.item-details > div.product-list-item > div.item-name-container > div > a',
  () => {
    document.querySelector('body').classList.add(`${ID}`);
    const productLists = isIncludesFromProdList();
    if (!productLists) {
      return;
    }
    const mq = window.matchMedia('(min-width: 767px)');
    mq.addListener(WidthChange);
    WidthChange();
  }
);

export default () => {
};
